<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->

- [Ushur UI](#ushur-ui)
  - [Getting Started](#getting-started)
  - [VsCode Editor Setup](#vscode-editor-setup)
    - [Auto-fixing eslint issues](#auto-fixing-eslint-issues)
    - [Starting the server](#starting-the-server)
    - [Committing Code](#committing-code)
    - [Pushing Code](#pushing-code)
  - [Generating API Client Code](#generating-api-client-code)
  - [Upgrading JointJs](#upgrading-jointjs)
  - [React Component Testing](#react-component-testing)
    - [Overview](#overview)
    - [Usage](#usage)
    - [Code Coverage Configuration](#code-coverage-configuration)
  - [BDD Testing](#bdd-testing)
    - [Overview](#overview-1)
    - [Usage](#usage-1)
    - [Code Coverage Configuration](#code-coverage-configuration-1)
  - [Traditional Functional/End to End Testing](#traditional-functionalend-to-end-testing)
    - [Overview](#overview-2)
    - [Usage](#usage-2)
    - [Code Coverage Configuration](#code-coverage-configuration-2)
  - [i18n - Internationalization](#i18n---internationalization)
    - [Overview](#overview-3)
    - [Writing new component or updating](#writing-new-component-or-updating)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

# Ushur UI

This repository contains the implementation of the Ushur workflow builder in ReactJs.

The table of contents for this document can be auto-generated by the command:

```bash
npm run generate:toc
```

Just re-run it upon changing this file.

## Getting Started

## VsCode Editor Setup

If you prefer VsCode as an editor, here are some tips.

### Recommended extensions

* [vscode-eslint](https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint)

* [sonarlint](https://marketplace.visualstudio.com/items?itemName=SonarSource.sonarlint-vscode)

* [codespell checker](https://marketplace.visualstudio.com/items?itemName=streetsidesoftware.code-spell-checker)

* [cucumber](https://marketplace.visualstudio.com/items?itemName=CucumberOpen.cucumber-official)

* [openapi](https://marketplace.visualstudio.com/items?itemName=42Crunch.vscode-openapi)

* [tailwindcss](https://marketplace.visualstudio.com/items?itemName=bradlc.vscode-tailwindcss)

### Auto-fixing eslint issues

Install the [Eslint extension](https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint).

Go to your [settings editor](https://code.visualstudio.com/docs/getstarted/settings#_settings-editor)

and make sure you have:

* Eslint as a formatter ![eslint as a formatter](docs/vscode/eslint-formatter.png?raw=true "Title")


* General editor setup ![general editor setup](docs/vscode/editor-formatting.png?raw=true "Title")

* Your [VsCode settings JSON](https://code.visualstudio.com/docs/getstarted/settings#_settingsjson) should have the following:

```
    "editor.codeActionsOnSave": {
        "source.fixAll": true,
    },
    "eslint.validate": [
        "javascript",
        "javascriptreact",
        "typescript",
        "typescriptreact",
        "html",
    ],
    "editor.formatOnSave": true,
    "editor.formatOnPaste": true,
    "eslint.format.enable": true,
```

### Starting the server

Ensure you are running the correct version of NodeJs. If using [nvm](https://github.com/nvm-sh/nvm) you can just type the following in the root directory:

```bash
nvm use
```

To start the application against a mock server

```bash
npm run start:msw
```

To start the application against a real server locally:

```bash

npx cross-env REACT_APP_MOCK_SERVER=https://react2-ui.ushur.dev npm run start
```

where REACT_APP_MOCK_SERVER is the API server you wish to configure.

Open an insecure Chrome window to bypass CORS security:

```bash
npm run chrome:mac
```

or

For Windows users, please make sure you are using Git bash.

```bash
npm run chrome:win
```

For API requests to succeed with a real server, ensure that you have the user key setup as well. Go to the non-React app and then Chrome debugger->Application->Local Storage to copy the value of user key. Then go to the React app at http://localhost:3000 to create the 'user' key in local storage with that value. Then all requests to the api server will succeed.

### Committing Code

To commit code that has failing linter issues, etc. the following command can be used

```bash
git commit --no-verify
```

This helps if you are saving work in progress.

When the linter runs it will spellcheck comments and an IDE like VsCode will highlight spelling errors. See also https://www.npmjs.com/package/eslint-plugin-spellcheck

If there are words that are not recognized you can add them to the 'skipWords' section in

ushur-ui/.eslintrc.json

### Pushing Code

When you push code, React component tests are triggered. That is:

```
npm run test:coverage
```

To push code that has failing test cases the following command can be used

```bash
git push --no-verify
```

This helps if you are saving work in progress and need to push work remotely.

In CI/CD both React component tests and end to end tests are run with the command:

```
npm run test:ci
```

Feel free to run it locally as well before pushing although it can be slower than just React component tests.

## Generating API Client Code

The Open API specification [stored here](./openapi/ushur.yaml) is used to generate the API client and Typescript types in [this folder](./src/api).

There are several tools that help with editing the ushur.yaml file. One handy one is https://editor.swagger.io/.

To generate an API client and TypeScript types, issue the command:

```bash
npm run generate:api
```

This requires the following tool to be installed [swagger-codegen](https://github.com/swagger-api/swagger-codegen) first.

## Upgrading JointJs

Our app uses the paid version of JointJs. Periodically we should keep the library up to date.

Download the latest version from:
https://my.client.io/account

The download is a single file in zip format. However in package.json we use a .tar.gz format.

There are various tools to convert from a zip file to .tar.gz file . One of them is a NodeJs tool called zip2tar.

The directory ushur-ui/vendor is where the JointJs library file is to be stored.

First move the zip file there. For example if the downloaded JointJs file was named rappid_v3_6_1.zip some steps could be:

```
cd vendor
../node_modules/.bin/zip2tar rappid_v3_6_1.zip
rm rappid_v3_6_1.zip
```

Now update package.json to point to the new file:

"@clientio/rappid": "file:vendor/rappid_v3_6_1.tgz",

## React Component Testing

### Overview

See notes in [this presentation](https://docs.google.com/presentation/d/146ulcChtefPjuAyUbqoj5pxLn-3ixx_160b6fEEmRvs/edit#slide=id.g134542c42e6_0_742) which also contains links to a video session.

### Usage

To run component tests in watch mode:

```bash
npm run test
```

To run component tests in watch mode for a single file you can do:

```bash
npm run test <path to file>
```

For example:

```
npm run test src/features/canvas/data/canvasSlice.test.ts
```

Don't forget that you can also [focus on a single test case](https://jestjs.io/docs/api#testonlyname-fn-timeout) by temporarily changing test to test.only.


To debug test cases in VsCode, navigate to the file you want to test and use the VsCode debugger to run "Watch Single Test: React Component Testing":

![Debugging Tests in VsCode](docs/vscode/debugging-tests.gif?raw=true "Debugging Tests in VsCode")

To run tests with code coverage, run:

```bash
npm run test:coverage
```

When the tests finish, to see detailed code coverage results, open up the following file in the browser:

```bash
coverage/lcov-report/index.html
```

### Code Coverage Configuration

If for some reason you need to adjust the code coverage, see the "coverageThreshold" field in package.json.

Ideally we should be bumping up code coverage numbers as we write tests and aim for ~80-90% code coverage.

Note that if you really need to exclude code coverage there are various options including:

Ignoring a whole file:

```
/* istanbul ignore file */

```

Ignoring a function:

```
/* istanbul ignore next */
function myFunc() {
  console.log(
    "Not covered but won't appear on coverage reports as such"
  );
}
```

See also coveragePathIgnorePatterns in package.json and sonar-project.properties for Sonarlint configuration.

## BDD Testing

### Overview

Functional tests are run by the tool [Playwright](https://playwright.dev/). This tool is useful to validate more functional/end to end scenarios. Also, these are useful if the DOM mocking library provided by [jsdom](https://github.com/jsdom/jsdom) does not mock out certain features like SVG APIs, etc. That is, we cannot use [React Testing Library](https://testing-library.com/docs/react-testing-library/intro/) for everything kind of test.

Note that by default tests are configured to run against mocked out APIs using [msw](https://mswjs.io/) so that they can run in CI/CD pipelines.

Generally tickets created by the product team are specified using [BDD]("https://cucumber.io/docs/bdd/) syntax. We can take advantage of tools allow us to use essentially the same specifications and create automate tests from them.

That is, we can write specifications using [BDD]("https://cucumber.io/docs/bdd/) in the files at:

[tests/features](./tests/features/)

And write the test steps using BDD syntax in files at:

[tests/steps](./tests/steps/)

This helps not only validate that our product aligns with the vision set out by the product team but also serves as a form of very readable documentation of what our application is supposed to do.

### Usage

To run BDD tests, first make sure the app is running. You can run the app as you would normally OR you can also run the app without a browser as follows:

```bash
npm run start:msw:ci
```

To run tests invoke the command:

```bash
npm run test:bdd
```

To run a specific scenario (please note the extra dashes):

```bash
npm run test:bdd -- --name="Create Welcome Step"
```

To run tests with code coverage, run:

```bash
npm run test:bdd:coverage
```

When the tests finish, to see detailed code coverage results, open up the following file in the browser:

```bash
coverage/bdd/index.html
```

Also the name is for a specific scenario NOT the name of a feature.

To run tests by launching a browser where you can see tests running, invoke the command:

```bash
npm run test:bdd:live
```

If you want to run a specific scenario in any nested mode from test:bdd such as the following, please note additional dashes required and the name is a scenario NOT the name of a feature:

```
npm run test:bdd:live -- -- --name="Create Welcome Step"
```

You can also run it in watch mode. Changes to tests/code will trigger a re-run of a test:

```
npm run test:bdd:watch --  -c  "npm run test:bdd -- --name='Create Welcome Step'"

```

Or even in live mode with a browser launching.

```
npm run test:bdd:watch --  -c  "npm run test:bdd:live -- -- --name='Create Welcome Step'"
```

A tip: This is handy for debugging:

If a test fails, one way to debug things is to add a Playwright pause in your tests:

````
await page.pause()

To run tests by launching a browser and in debug mode, run:
```bash
npm run test:bdd:debug
````

This can be handy to step through the tests and explore selectors.

````

Then use the Explore box in the Playwright inspector to lookup elements.

There is a tool that sometimes can generate test code automatically. It isn't perfect but you can try:
```bash
npm run test:bdd:codegen
````

To generate a video for your tests:

```bash
npm run test:bdd:video
```

To run tests against a real server you can use:

```bash
BDD_BASE_URL=https://react2-ui.ushur.dev/mob3.0/ushur-ui/ npm run test:bdd:live
```

At the time of writing, you'll have to make sure you are first logged in however.

### Code Coverage Configuration

If for some reason you need to adjust the code coverage for BDD tests, see the configuration in .nycrc.bdd.json.

Ideally we should bump up code coverage every time we write tests and aim for ~80-90% code coverage.

## Traditional Functional/End to End Testing

### Overview

Tooling is also in place if we have a need for more end to end tests not bound by BDD specifications. For example, if BDD specs don't align well with certain types of testing and/or if we want to run complex scenarios against a real server.

### Usage

The following commands are available to support such tests.

To run general end to end tests:

```bash
npm run test:e2e
```

To run tests with a browser launching:

```bash
npm run test:e2e:live
```

To run tests without a browser launching, watching tests:

```bash
npm run test:e2e:watch
```

To run tests with a browser launching, watching tests:

```bash
npm run test:e2e:watch:live
```

To debug tests with a browser launching:

```bash
npm run test:e2e:watch:debug
```

To try and generate code for tests, run:

```bash
npm run test:e2e:codegen
```

To run tests against a real server you can use:

```bash
BASE_URL=https://react2-ui.ushur.dev/mob3.0/ushur-ui/ npm run test:e2e:live
```

At the time of writing, you'll have to make sure you are first logged in however.

### Code Coverage Configuration

If for some reason you need to adjust the code coverage for e2e tests, see the configuration in .nycrc.e2e.json.

Ideally we should bump up code coverage every time we write tests and aim for ~80-90% code coverage.

## i18n - Internationalization

### Overview

This section contains notes on supporting i18n when adding/updating code.

1. In `/ushur-ui/src/i18n/en.ts`, add a new key for a feature under `translation`.
   ex. `dataTables`
2. In a file requiring translation, the React hook useTranslation can be used to obtain the translation function `t`. Use the `keyPrefix` option to reference the feature's translation. Refer to the example in `ushur-ui/src/features/datatables/DataTables.react.tsx`.

```js
const { t } = useTranslation("translation", { keyPrefix: "dataTables" });
```

3. Now, wherever you want to translate a key, use as `t('key')` where key is the english keyword.
4. Optionally, you can update translated string in `i18n/es` for other languages.
